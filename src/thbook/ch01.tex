\chapter Introduction.

Therion is a tool for cave surveying. Its purpose is to help 

\list
* archive survey data on computer in a form as close to the original notes and 
  sketches as possible;
* draw a nice up-to-date plan or elevation map; 
* create a realistic 3D model of the cave.
\endlist

It runs on Unix, Linux, MacOS X and Win32 operating systems. 
Source code and precompiled binaries for Linux and Win32 
systems are available on the Therion homepage (\www{|http://www.therion.sk|}%
{http://www.therion.sk}).

Therion is distributed under the \www{GNU General Public License}%
{http://www.gnu.org/}.

\subchapter Why Therion?.

In the 1990s we've done a lot of caving and cave surveying. Some computer 
programs existed which displayed survey shots and stations after loop closure and 
error elimination. These were a great help, especially for large and complicated 
cave systems. We used the output of one of them---TJIKPR---as a background 
layer with survey stations for hand-drawn maps. After finishing a huge 160 
page Atlas of Dead Bats Cave, we soon had a problem: we found new passages
connecting between known passages and surveyed them. After processing in TJIKPR, 
the new loops influenced the position of the old surveys;
most survey stations now had a slightly different position from before due to the
changed error distribution. So we could either draw the whole Atlas again, 
or accept that the location of some places was not accurate---in the case of loops 
with a length of approximately 1\,km there were sometimes errors of about 
10\,m---and try to distort the new passages to fit to old ones.

These problems remained when we tried to draw maps using some CAD programs. It 
was always hard to add new surveys without adapting the old ones to the newly 
calculated positions of survey stations in the whole cave. We found no program that was 
able to draw an up-to-date complex map (i.e.~not just survey shots with LRUD envelope), 
in which the old parts are modified according to the most recent known coordinates 
of survey stations.

In 1999 we begun to think about creating own program for map drawing. We knew 
about programs which were perfectly suited for particular sub-tasks. There 
was \MP, a high level programming language for vector graphics description, 
Survex for excellent processing of survey shots, and \TeX\ for typesetting the 
results. We had only to glue them together. By Xmas 
1999 we had a minimalistic version of Therion working for the first time. This 
consisted only of about 32\,kB of Perl scripts and \MP\ macros but served the 
purpose of showing that our ideas were implementable.

During 2000--2001 we searched for the optimal format of the input data, programming 
language, concept of interactive map editor and internal algorithms with the 
help of Martin Sluka (Prague) and Martin Heller (Z\"urich). In 2002 we were able to 
introduce the first really usable version of Therion, which met our requirements.


\subchapter Features.

All input files---including 2D maps---for Therion are in text format, which is 
described in detail in later chapters. You may create these files in an arbitrary plain 
text editor like {\it ed} or {\it vi}. They contain instructions for Therion 
like 

|point 1303 1004 pillar| 

where {\tt point} is a keyword for point symbol 
followed by its coordinates and a symbol type specification.

Hand-editing of such files is not easy---especially when you draw maps, you 
need to think in spatial (Cartesian coordinate) terms. Thus there is a special IDE 
for Therion called XTherion. XTherion works as an advanced text editor, map 
editor (where maps are drawn fully interactively), and compiler.

Compiler? Yes, Therion works like other compilers---it reads its input
text files and translates them to other formats, suitable for viewing or 
printing a map or cave model.

It may look quite complicated, but this approach has a lot of advantages:

\list
* There is strict separation of data and visualization. The data files specify 
  only what is where, not what it looks like. The visual 
  representation is added by \MP\ in later phases of data processing. (It's very 
  similar concept to XML data representation.) 
  
  This makes it possible to change map symbols used without changing the 
  input data, or merge more maps created by different persons in different 
  styles into one map with unified map symbols set.
  
* All data are relative to survey station positions. If the coordinates
  of survey stations are changed in the process of loop closure, then all relevant
  data is moved correspondingly, so the map is always up-to-date.

* Therion is not dependent on particular operating system, character encoding
  or input files editor.

%* ...
\endlist

\subchapter How does it work?.

``A program should do one thing, and do it well.'' (Ken Thompson) 
Therefore we use some valuable external programs, which are related to the problems of cave 
surveying, typesetting and data visualization. Therion can then do its task 
much better than if it was a standalone application in which you could calibrate 
your printer or scanner and with one click send e-mail with your data.

The compilation of Therion requires an ANSI C/C++ compiler. 
If you use the precompiled version, you don't need this.

To run it you need:
\list
* recent Survex (necessary if you want to process any survey data)
* \TeX\ distribution with at least \TeX\ with Plain format, 
  recent pdf-$\varepsilon$-\TeX, and \MP\ with accompanying programs. 
  (\TeX\ and friends is necessary only if you want to create 2D maps.)
* Perl 5.5 and newer (for 2D maps)
* Tcl/Tk 8.4 and newer (for XTherion)
\endlist

For displaying the results you need:
\list
* Aven or xcaverot from Survex package for viewing the simple 3D model
* any PDF viewer like Acrobat Reader, ghostscript or xpdf for displaying  
  2D maps
\endlist

Detailed instructions for Therion installation are in the {\it Appendix}.

So, now it's clear what Therion needs, let's have a look at the way 
it interacts with all these programs:

\pic{mp/schema.1}

DON'T PANIC! When your system is set-up right the majority of this is hidden from 
the user and all necessary programs are run automatically by Therion. 

For working with Therion it is enough to know that you have to create input data 
(best done with XTherion), run Therion, and display output files 
(3D model, PDF map, log file) in the appropriate program. 

For those who want to understand more about it, here is a brief explanation of 
the above flowchart. Program names are in roman font, data files in italics. 
Arrows show data flow between programs. Temporary data files are not shown. 
Meaning of colors:

\list
* black---Therion programs and macros (XTherion is written in Tcl/Tk, thPdf in
  Perl, so they need these interpreters to run)
* blue---Survex programs
* red---\TeX\ package
* green---input files created by the user and output files created by Therion
\endlist

Therion itself does the main task. It reads the input files, interpretes them, 
exports survey data to Survex, which does the loop closure. Then it reads back 
coordinates of survey stations and transforms all other data (e.g.~2D maps) 
according to them. Therion exports data for 2D maps in \MP\ format. \MP\ gives 
the actual shape to abstract map symbols according to map symbol definitions; it
creates a lot of PostScript files with small fragments of the cave. These are 
converted to a PDF-like format by thPdf and theps2pdf, which forms input data 
for pdf\TeX. Pdf\TeX does all the typesetting and creates a PDF file of the cave 
map. Therion may also export simple 3D model (survey shots only) in Survex *.3d 
and Compass *.plt formats. 

[Complex 3D in the future]


% \subchapter Thinking in Therion.



\endinput
