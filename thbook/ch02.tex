\chapter Creating data files.

\subchapter Basics.

The input files for Therion are in text format. There are a few rules about how 
such a file should look:

\list 
* There are two kinds of commands. One-line commands and
  multi-line commands.  

* A one-line command is terminated by an end of
  line character. The syntax of these is

  |command arg1 ... argN [-option1 value1 -option2 value2 ...]|

  where {\it arg1 ... argN} are obligatory arguments, and pairs 
  {\it -option value} are options, which you may freely omit. 
  Which arguments and options are available depends on the particular command.
  An example may be

  |point 643.5 505.0 gradient -orientation 144.7|

  with three obligatory arguments and one optional option/value pair. Sometimes options 
  have no or multiple values. 
  
* Multi-line commands begin similarly to one line commands, but continue on 
  subsequent lines until explicit command termination. These lines may contain
  either data or options, which are applied to subsequent data. If a data line
  starts with a word reserved for an option, you have to insert `|!|' in front
  of it. The syntax is

  |command arg1 ... argN [-option1 value1 -option2 value2 ...]
  ...
  optionX valueX
  data
  ...
endcommand|

Again, for better illustration, a real example follows:  

|line wall -id walltobereferenced
  1174.0 744.5
  1194.0 756.5 1192.5 757.5 1176.0 791.0
  smooth off
  1205.5 788.0 1195.5 832.5 1173.5 879.0
endline|

This command |line| has one obligatory argument, a line type (passage wall in 
this case), followed by one option. The next two lines contain data (coordinates of 
B\'ezier curves to be drawn). The next line (``|smooth off|'') specifies an option which 
applies to subsequent data (i.e. not for the whole line, unlike the option |-id| 
in the first line) and the last line contains some more data.

* if the value of an option or argument contains spaces, you should enclose this
  value in \hbox{|" "|} or \hbox{|[ ]|}. If you want to put a double-quote |"| into 
  text in \hbox{|" "|} you need to insert it twice. Quotes are used for strings; 
  brackets for numerical values and keywords.

* each line ending with a backslash (|\|) is considered to continue on 
  the next line, as if there was neither line-break nor backlash.

* everything that follows |#|, until the end of line---even inside a command---is 
  considered to be a comment, and is ignored.
\endlist


\subchapter Data types.

Therion uses following data types:

\list
* {\it keyword} = a sequence of |A-Z|, |a-z|, |0-9| and |_-| characters 
             (not starting with `|-|').
* {\it ext\_keyword} = keyword that can also contain |+*/.,'| characters, 
            but not on the first position.
* {\it date} = a date (or a time interval) specification in a format\hfil\break
          |YYYY.MM.DD@HH:MM:SS.SS - YYYY.MM.DD@HH:MM:SS.SS| or |-|
          to leave a date unspecified.
* {\it person} = a person's first name and surname separated by whitespace characters.
            Use `|/|' to separate first name and surname if there are 
            more names.
* {\it string} = a sequence of any characters.
* {\it units} = length units supported: 
           meter[s], centimeter[s], inch[es], feet[s], yard[s]
           (also m, cm, in, ft, yd).
           Angle units supported: degree[s], minute[s] (also deg, min), 
	   grad[s], mil[s]. A degree value may be entered in decimal notation
	   ($x.y$) or in a special notation for degrees, minutes and seconds
	   ($deg[{:}min[{:}sec]]$).
\endlist


\subchapter Data format.

The syntax of input files is explained in the description of
individual commands. Studying the example files distributed with
Therion will help you understand. See also an example in the {\it Appendix}.

Each of the following sections describes
one Therion command using the following structure:

{\it Description:} notes concerning this command.

{\it Syntax:} schematic syntax description. 

{\it Context:} specifies the context in which is this command allowed. 
The {\it survey} context means that the commmand must be enclosed by 
|survey ... endsurvey| pair. The {\it scrap} context means that the command must be 
enclosed within |scrap ... endscrap| pair. Context {\it all} means that 
the command may be used anywhere.

{\it Arguments:} a list of the obligatory arguments with explanations.

{\it Options:} a list of the available options.

{\it Command-like options:} options for multi-line commands, which can be specified 
   among the data lines.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubchapter `encoding'.

\description
  sets the encoding of input file. This allows the use of non-ASCII characters
  in input files.
\enddescription

\syntax
  |encoding <encoding-name>|
\endsyntax

\context
  It should be the very first command in the file.
\endcontext

\arguments
* |<encoding-name>| = to see a list of all the supported encoding names, run Therion with 
  |--print-encodings| option. `UTF-8' (Unicode) and `ASCII' (7\,bit) encodings 
  are always supported.
\endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubchapter `input'.

\description
  inserts the contents of a file in place of 
  the command. Default extension is `.th' and may be ommited. For greatest 
  portability use relative paths and Unix slashes `|/|', not Windows 
  backslashes `|\|', as 
  directory separators.
\enddescription

\syntax
  |input <file-name>|
\endsyntax

\context
  all
\endcontext

\arguments
*  |<file-name>|
\endarguments

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubchapter `survey'.

\description
  Survey is the main data structure. Each data object must belong to a 
  survey. Surveys may be nested---this allows a hierarchical structure 
  to be built. 

  Each survey has its own namespace specified by its |<id>| argument. Objects 
  (like survey stations or scraps; see below) which belong to a subsurvey of 
  the current survey are referenced as
  
  |<object-id>@<subsurvey-id>|,
  
  or, if there are more nesting levels
  
  |<object-id>@<subsubsurvey-id>.<subsurvey-id>|.\[Note: it's not possible to 
  reference any object from the higher-level surveys.]
  
  This means, that object identifiers must be unique only in the scope of one 
  survey. For instance, survey stations names can be the same if they are 
  in different surveys. This allows stations to be numbered from 0 in each survey or 
  the joining of two caves into one cave system without renaming survey stations.

\enddescription

\syntax
      |survey <id> [OPTIONS]
       ... other therion objects ...
       endsurvey [<id>]|
\endsyntax

\context
  none, survey
\endcontext

\arguments
*|<id>| = survey identifier
\endarguments

\options 
* |declination <specification>| = set the default declination for 
  all data objects in this survey (which can be overridden by
  declination definitions in subsurveys). The |<specification>| 
  has three forms:

  1. |[]| an empty string. This will reset the declination definition.

  2. |[<value> <units>]| will set a single value (also for undated surveys).

  3. |[<date1> <value1> [<date2> <value2> ... ] <units>]| 
     will set declination for several dates. Then the declination
     of each shot will be set according to the date specification
     of the data object. If you want to explicitely set the declination
     for undated survey data, use `|-|' instead of date.

* |person-rename <old name> <new name>| = rename a person whose name has been
  changed

* |title <string>| = description of the object
\endoptions


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubchapter `centreline'.

\description
  Survey data (centreline) specification. The syntax is borrowed from Survex 
  with minor modifications; the Survex manual may be useful as an additional
  reference for the user. A synonym term `centerline' may be used.
\enddescription

\syntax
      |centreline [OPTIONS]
          date <date>
          team <person> [<roles>]
          explo-date <date>
          explo-team <person>
          instrument <quantity list> <description>
          calibrate <quantity list> <zero error> [<scale>]
          units <quantity list> [<factor>] <units>
          sd <quantity list> <value> <units>
          grade <grade list>
          declination <value> <units>
          infer <what> <on/off>
          mark <type>
          flags <shot flags>
          station <station> <comment> [<flags>]
          fix <station> [<x> <y> <z> [<std x> <std y> <std z>]]
          equate <station list>
          data <style> <readings order>
          break
          ...
          [SURVEY DATA]
          ...
        endcentreline|
\endsyntax

\context
  survey
\endcontext

\options
  * |id <ext_keyword>| = id of the object
  * |author <date> <person>| = author of the data and it's creation date
  * |copyright <date> <string>| = copyright date and name
  * |title <string>| = description of the object
\endoptions


\comopt
  * |date <date>| = survey date. If multiple dates are specified,
    a time interval is created.
  * |explo-date <date>| = discovery date. If multiple dates are specified,
    a time interval is created.
  * |team <person> [<roles>]| = a survey team member. The first argument
    is his/her name, the others describe the roles of the person in
    the team (optional---currently not used). The following role keywords are
    supported: station, length, tape, compass, bearing, clino,
    gradient, counter, depth, station, position, notes, pictures, 
    instruments (insts), assistant (dog).
  * |explo-team <person>| = a discovery team member. 
  * |instrument <quantity list> <description>| = description
    of the instrument that was used to survey the given quantities (same
    keywords as team person's role)
  * |infer <what> <on/off>| = `|infer plumbs on|' tells the
    program to interpret gradients $\pm90\,^\circ$ 
    as UP/DOWN (this means
    no clino corrections are applied). `|infer equates on|' will case program to
    interpret shots with 0 length as equate commands (which means that no
    tape corrections are applied)
  * |declination <value> <units>| = sets the declination for subsequent
    shots $$true\ bearing = measured\ bearing + declination.$$
    If no declination is specified, or the declination is reset (|-|),
    then a valid declination specification is searched for in all surveys
    the data object is in. See declination option of survey command.
  * |sd <quantity list> <value> <units>| = sets the 
    standard deviation for the given measurements. The Quantity list can 
    contain the following keywords: length, tape, bearing, compass, 
    gradient, clino, counter, depth, x, y, z, position, easting, dx,
    northing, dy, altitude, dz.
  * |grade <grade list>| = sets standard deviations according to the
    survey grade specification (see grade command). All previously
    specified standard deviations or grades are lost. If you want 
    to change an SD, use the sd option after this command. If multiple
    grades are specified, only the last one applies. You can specify
    grades only for position or only for surveys. If you want to
    combine them, you must use them in one grade line.
  * |units <quantity list> [<factor>] <units>| = set the units
    for given measurements (same quantities as for sd).
  * |calibrate <quantity list> <zero error> [<scale>]| = set the
    instrument calibration. The measured value is calculated using the
    following formula:
    $measured\ value = (read\ value - zero\ error) \times scale$.
    The supported quantities are the same as sd.
  * |break| = can be used with interleaved data to separate two traverses
  * |mark <type>| = set the type of the station. |<type>| is one of: fixed, 
    painted and temporary (default).
  * |flags <shot flags>| = set flags for following shots. The supported
    flags are: surface (for surface measurements), duplicate (for
    duplicate surveys). Both are excluded from length calculations.
    Also ``|not|'' is allowed before a flag.
  * |station <station> <comment> [<flags>]| = set the station comment
    and flags: entrance or continuation. If |""| is specified as a
    comment, it is ignored.
  * |fix <station> [<x> <y> <z> [<std x> <std y> <std z>]]| 
    = fix station coordinates (with specified errors---only 
    the units transformation, not calibration, is applied to them).
  * |equate <station list>| = set points that are equivalent
  * |data <style> <readings order>| = set data style (normal, topofil,
    diving, cartesian, cylpolar, nosurvey) and readings order. Reading
    is one of the following keywords: station, from, to, tape/length, 
    [back]compass/[back]bearing, [back]clino/[back]gradient, 
    depth, fromdepth, todepth, depthchange, counter, 
    fromcount, tocount, northing, easting, altitude,
    up/ceiling, down/floor, left, right, ignore. 
    For interleaved data both newline and direction keywords
    are supported. If backward and forward compass or clino
    reading are given, the average of them is computed.
    See Survex manual for details.
\endcomopt



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsubchapter `scrap'.

\description
  Scrap is a piece of 2D map, which doesn't contain overlapping passages
  (i.e.~all the passages may be drawn on the paper without overlapping).
  For small and simple caves, the whole cave may belong to one scrap. 
  In complicated systems, a scrap is usually one chamber or one passage. 
  Ideally, a scrap contains about 100~m of the cave. Each scrap is processed 
  separately by \MP; scraps which are too large may exceed \MP's memory and 
  cause errors.
  
  Scrap border consits of lines with the |-outline out| or |-outline in| 
  options (passage walls have |-outline out| by default). These line shouldn't
  intersect---otherwise Therion (\MP) can't detemine the interior of the scrap 
  and \MP\ issues a warning message ``|scrap outline intersects itself|''.

  Each scrap has its own local cartesian coordinate system, which usually 
  corresponds with the millimeter paper (if you measure the coordinates of map
  symbols by hand) or pixels of the scanned image (if you use XTherion).
  Therion does the transformation from this local coordinate system to the 
  real coordinates using the positions of survey stations, which are 
  specified both in the scrap as point map symbols and in centreline data.
  If the scrap doesn't contain at least two survey stations with the |-name| 
  reference, you have
  to use the |-scale| option for calibrating the scrap. (This is usual for
  cross sections.) 
  
  The transformation consists of the  following steps: 
    \list  
    * Linear transformation (shifting, scaling and rotation) which `best' fits
      stations drawn in the scrap to real ones. `Best' means that the sum of 
      squared distances between corresponding stations before and after 
      transformation is minimal. The result is displayed red if |debug| option 
      of the |layout| command is set |on|.
    * Non-linear transformation of the scrap which (1) moves survey stations
      to their correct position, (2) is continuos. Displayed blue in the |debug| 
      mode.
    * Non-linear transformation of the scrap which (1) moves joined points
      together, (2) doesn't move survey stations, (3) is continuos. 
      Finally the position of curves' control points is adjusted to preserve 
      smoothness. The result is final map.
    \endlist
    
\enddescription

\syntax |scrap <id> [OPTIONS]
       ... point, line and area commands ...
       endscrap [<id>]|
\endsyntax

\context
  survey
\endcontext

\arguments
  *|<id>| = scrap identifier
\endarguments

\options
  * |projection <specification>| = specifies the drawing projection.
    Each projection is identified by a type and optionally by an index
    in the form |type[:index]|. The index can be any keyword. The following 
    projection types are supported:

    1. |none| = no projection, used for cross sections or maps that
       are independent of survey data (e.g.~digitization of old maps where 
       no centreline data are avaiable). 
       No index is allowed for this projection.

    2. |plan| = basic plan projection (default).

    3. |elevation| = orthogonal projection which optionally takes a view 
       direction as an argument (e.g.~|[elevation 10]| or |[elevation 10 deg]|).

    4. |extended| = extended elevation.

  * |scale <specification>| = 
    is used to pre-scale (convert coordinates from pixels to 
    meters) the scrap data. If scrap projection is none, this is the only 
    transformation that is done with coordinates.  
    The |<specification>| has four forms:

    1. |<number>| = |<number>| meters per drawing unit.

    2. |[<number> <length units>]| = |<number> <length units>| per
       drawing unit.

    3. |[<num1> <num2> <length units>]| = |<num1>| drawing units 
       corresponds to |<num2> <length units>| in reality.

    4. |[<num1> ... <num8> [<length units>]]| = this is the most
       general format, where you specify, in order, the $x$ and $y$ coordinates
       of two points in the scrap and two points in reality.
       Optionally, you can also specify units for the coordinates of the `points in reality'.
       This form allows you to apply both scaling and rotation to the scrap.
  * |stations <list of station names>| = stations you want to plot
    to the scrap, but which are not used for scrap transformation. You don't have
    to specify (draw) them with the |point station| command.
  * |3d <on/off/auto>| = specify if the scrap should be used in 3D model 
    reconstruction

  * |author <date> <person>| = author of the data and it's creation date
  * |copyright <date> <string>| = copyright date and name
  * |title <string>| = description of the object
\endoptions




\subsubchapter `point'.

\description
Point is a command for drawing a point map symbol.
\enddescription

\syntax
  |point <x> <y> <type> [OPTIONS]|
\endsyntax

\context
  scrap
\endcontext

\arguments
  * |<x>| and |<y>| are the drawing coordinates of an object.
  * |<type>| determines the type of an object. The following
    types are supported: 

    {\it special objects:} 
    |station|\[Survey station. For each scrap (with the exception of scraps 
      in `none' projection) at least one station with station reference 
      (|-name| option) has to be specified.],  
    |section|\[|section| is an anchor for placing the cross-section at this 
      point.  This symbol has no visual representation. The cross section
      must be in the separate scrap with `none' projection specified. 
      You can specify it through the |-scrap| option.];

    {\it labels:} |label|, |remark|, |altitude|, |height|, |passage-height|, 
    |station-name|\[If no text is specified, the name of the nearest
      station is used.], 
    |date|;

    {\it symbolic passage fills:}\[Unlike other symbols, these are
      clipped by the scrap border]
    |bedrock|, |sand|, |raft|, |clay|, |pebbles|,
    |debris|, |blocks|, |water|, |ice|, |guano|;

    {\it speleothems:} |flowstone|, |moonmilk|, |stalactite|, |stalagmite|,
    |pillar|, |curtain|, |helictite|, |soda-straw|, |crystal|, |wall-calcite|,
    |popcorn|, |disk|, |gypsum|, |gypsum-flower|, |aragonite|, |cave-pearl|,
    |rimstone-pool|, |rimstone-dam|, |anastomosis|, |karren|, |scallop|,
    |flute|, |raft-cone|;

    {\it equipement:} |anchor|, |rope|, |fixed-ladder|, |rope-ladder|, |steps|,
    |bridge|, |traverse|, |camp|, |no-equipement|;

    {\it passage ends:} |continuation|, |narrow-end|, |low-end|, 
    |flowstone-choke|, |breakdown-choke|, |entrance|;

    {\it others:} |archeo-material|, |paleo-material|, |vegetable-debris|, 
    |root|, |water-flow|, 
    |spring|\[Always use |spring| and |sink| symbols with a |water-flow| arrow.], 
    |sink|, 
    |air-draught|\[Number of ticks is set according to |-scale| option],
    |gradient|.

\endarguments


\options
  * |subtype <keyword>| = determines the object's subtype. The following
    subtypes for given types are supported: 
    
    {\it station:} |temporary| (default), |painted|, |natural|, |fixed|;

    {\it water-flow:} |permanent| (default), |intermittent|, |paleo|.

  * |orientation/orient <number>| = defines the orientation
    of the symbol. If not specified, it's oriented to north.
    0 $\le$ |number| $<$ 360.
  * |align| = alignment of the symbol or text. The following values
    are accepted: center, c, top, t, bottom, b, left, l, right, r,
    top-left, tl, top-right, tr, bottom-left, bl, bottom-right, br.
  * |scale| = symbol scale, can be: 
    tiny (xs), small (s), normal (m), large (l), huge (xl). Normal is default.
  * |place <bottom/default/top>| = where to place the symbol relatively
    to other objects.
  * |clip <on/off>| = specify whether a symbol is clipped by the scrap border.
    You cannot specify this option in the following symbols: station,
    station-name, label, remark, date, altitude, height, passage-height.
  * |visibility <on/off>| = displays/hides an object
  * |id <ext_keyword>| = id of the object

    {\it Type-specific options:}\Nobreak

  * |name <reference>| = if the point type is station, this
    option gives the reference to the real survey station.
  * |extend <specification>| = if the point type is station and scrap
    projection is extended elevation, you can
    adjust the extension of the centreline using this option. The |<specification>| is a list
    of one or more followig keywords:

    1. |left| = indicates extension to the left

    2. |right| = the opposite of above. If no extension direction is
       given, Therion uses the direction of the previous station, or
       right, if no such station exists.

    3. |root| = determines the starting node for extension.

    4. |sticky <on/off>| = two keywords that identify whether other
       scraps can be attached to this station. The default is true for
       end-station.

    5. |previous/prev <reference>| = reference to previous station
       (or point of type station)
  * |scrap <reference>| = if the point type is section, this is a 
    reference to a cross-section scrap. 
  * |text| = text of the label or remark. It may contain following formatting
    keywords:
    
    |<br>| = line break
    
    |<center>/<centre>|, |<left>|, |<right>| = line alignment for multi-line labels. 
    Ignored if there is no |<br>| tag.
    
    |<thsp>| = thin space
    
    |<rm>|, |<it>|, |<bf>|, |<ss>|, |<si>| = font switches
        
  * |value| = value of height, passage-height or altitude label

      {\it height:} according to the sign of the value (positive, negative or
      unsigned), this type of symbol represents chimney height, pit depth
      or step height in general. The numeric value can be optionally followed by `|?|', 
      if the value is presumed and units can be added 
      (e.g.~|-value [40? ft]|).
        
      {\it passage-height:} the following four forms of value are supported:
      |+<number>| (the height of the ceiling), |-<number>| (the depth of the 
      floor or water depth), |<number>| (the distance between floor 
      and ceiling) and |[<number> <number>]| (the distance to ceiling and 
      distance to floor).

      {\it altitude:} the value specified is the altitude difference from 
      the nearest station. If the altitude value is prefixed by ``|fix|''
      (e.g. |-value [fix 1300]|), this value is used as an absolute altitude. 
      The value can optionally be followed by length units.
\endoptions


\subsubchapter `line'.

\description
Line is a command for drawing a line symbol on the map. Each line symbol is 
oriented and its visualization may depend on its orientation (e.g.~pitch edge 
ticks). The general rule is that the free space is on the left, rock on the 
right. Examples: the lower side of a pitch, higher side of a chimney and 
interior of a passage are on the left side of pitch, chimney or wall symbols, 
respectively.  
\enddescription

\syntax
  |line <type> [OPTIONS]
         altitude <value>
         border <on/off>
         clip <on/off>
         close <on/off/auto>
         direction <begin/end/both/none/point>
         gradient <none/center/point>
         head <begin/end/both/none>
         mark <keyword>
         orientation/orient <number>
         outline <in/out/none>
         place <bottom/default/top>
         reverse <on/off>
         size <number>
         r-size <number>
         l-size <number>
         smooth <on/off/auto>
         subtype <keyword>
         text <string>
         ...
         [LINE DATA]
         ...
       endline|
\endsyntax

\context
  scrap
\endcontext

\arguments
   * |<type>| is a keyword that determines the type of line.
     The following types are supported: 
     
     {\it passages:} |wall|, |contour|, 
     |slope|\[Slope line marks upper border of the slopy area. It's 
       necessary to specify |l-size| in at least one point. Gradient lines
       length and orienation is an average of specified |l-size|s and
       |orientation|s in the nearest points. If there is no orientation
       specification, gradient marks are perpendicular to the slope line.], 
     |floor-step|, |pit|, 
     |ceiling-step|, |chimney|, |overhang|;

     {\it passage fills:} |flowstone|, 
     |rock-border|\[Outer outline of large boulders. If the line is closed, 
       it is filled with the background colour.], 
     |rock-edge|\[Inner edges of large boulders.], 
     |water-flow|;
     
     {\it labels:} |label|;

     {\it special:} |border|, |arrow|, 
     |section|\[Line showing cross-section position. 
       If both control points of a B\'ezier curve are given 
       then the line is drawn up to the perpendicular projection of 
       the first control point and from the projection of the section control
       point. No section curve is allowed.], 
     |survey|\[Survey line is automatically drawn by Therion.].
\endarguments


\comopt
       * |subtype <keyword>| = determines line subtype. The following
         subtypes are supported for given types:  

         {\it wall:} |invisible|, |bedrock| (default), |sand|, |clay|, 
         |pebbles|, |debris|, |blocks|, |ice|, |underlying|, |unsurveyed|, 
         |presumed|  ;

         {\it border:} |visible| (default), |invisible|, |temporary|;
         
         {\it water-flow:} |permanent| (default), |conjectural|, |intermittent|.
         
       * |[LINE DATA]| specify either the coordinates of a line segment
         |<x> <y>|, or coordinates of a B\'ezier curve arc 
         |<c1x> <c1y> <c2x> <c2y> <x> <y>|, where |c| indicates the control
         point.
       * |close <on/off/auto>| = determines whether a line is closed 
         or not
       * |mark <keyword>| = is used to mark the point on the line (see
         |join| command).
       * |orientation/orient <number>| = orientation of the symbols
         on the line. If not specified, it's perpendicular to the 
         line on its left side. 0 $\le$ |number| $<$ 360.
       * |outline <in/out/none>| = determines whether the line serves as
         a border line for a scrap. Default value is `|out|' for
         walls, `|none|' for all other lines. Use |-outline in| for 
         large pillars etc.
       * |reverse <on/off>| = whether points are given in reverse order.
       * |size <number>| = line width (left and right sizes are set to 
         one half of this value)
       * |r-size <number>| = size of the line to the right
       * |l-size <number>| = same to the left. Required for |slope| type.
       * |smooth <on/off/auto>| = whether the line is smooth at the given point.
         Auto is default.
       * |place <bottom/default/top>| = where to place the symbol relative
         to other objects.
       * |clip <on/off>| = specify whether a symbol is clipped by the scrap border.
       * |visibility <on/off>| = displays/hides an object

    {\it Type-specific options:}\Nobreak

       * |altitude <value>| = can be specified only with the wall type.
         This option creates an altitude label on the wall. The value
         gives the altitude difference of the point on the wall 
         relative to the nearest station. The value can be prefixed
         by a keyword ``|fix|'', then no nearest station is taken into
         consideration; the absolue given value is used instead.
         Units can follow the value. Examples: |+4|, |[+4 m]|,
         |[fix 1510 m]|.
       * |border <on/off>| = this option can be specified only with
         the `slope' symbol type. It switches on/off the border line of 
         the slope.
       * |direction <begin/end/both/none/point>| = can be used only
         with the section type. It indicates where to put 
         a direction arrow on the section line. None is default.
       * |gradient <none/center/point>| = can be used only with the contour
         type and indicates where to put a gradient mark on the contour line.
         If there is no gradient specification, behaviour is symbol-set 
         dependent (e.g. no tick in UIS, tick in the middle in SKBB).
       * |head <begin/end/both/none>| = can be used only with the arrow
         type and indicates where to put an arrow head. End is default.
       * |text <string>| = valid only for label lines.
\endcomopt

\options
  * |id <ext_keyword>| = id of the object
\endoptions


\subsubchapter `area'.

\description
Area is specified by surrounding border lines. They may be of any type, but 
must be listed in order and each pair of consecutive lines must intersect. 
In order to be sure that lines intersect even after scrap transformation
you may e.g.~continue a lake border 1\,cm behind a passage wall---these 
overlaps will be automatically clipped by scrap border.
You may use invisible border to achieve this inside of the passage.


\enddescription

\syntax
  |area <type>
         place <bottom/default/top>
         clip <on/off>
         visibility <on/off>
       ... border line references ...
       endarea|
\endsyntax

\context
  scrap
\endcontext

\arguments
  * |<type>| is one of following: |water|, |sump|, |sand|, |debris|.
\endarguments

\comopt
  * the data lines consist of border line references (IDs)
  * |place <bottom/default/top>| = where to place the symbol relative
    to other objects (bottom by default).
  * |clip <on/off>| = specify whether a symbol is clipped by the scrap border.
  * |visibility <on/off>| = displays/hides an object
\endcomopt

\options
  * |id <ext_keyword>| = id of the object
\endoptions


\subsubchapter `map'.

\description
  A map is a collection of either scraps or other maps of the same projection type.
  It simplifies the data management when selecting data for output.
\enddescription

\syntax
  |map <id>
        ... scrap or other map references ...
        break
        ... next level scrap or other map references ...
        preview <above/below> <other map id>
      endmap|
\endsyntax

\context
  survey
\endcontext

\arguments
  *|<id>| = scrap identifier
\endarguments

\comopt
  * the data lines consist of scrap or map references. Note that
    you can not mix them together.
  * scraps following the |break| will be placed on another level
  * |preview <above/below> <other map id>| will put the outline of
    the other map in the specified preview position relative to the
    current map. 

    Preview is displayed only if the map is in the |map-level| level as
    specified by the |select| command.
    
    Use the revise command if you want to add maps from higher levels to the
    preview.
\endcomopt

\options
  * |title <string>| = description of the object
\endoptions


\subsubchapter `join'.

\description
  Join works in two modes: it joins either two scraps or two or more points 
  in a map together. When joining scraps, only passage walls are joined.
  It's a good idea to place a scrap join in the passage which is as simple 
  as possible, otherwise you have to specify join for each pair of objects 
  which should be joined. 
  
  If you want some object which is clipped by a scrap boundary to continue
  to a neighbouring scrap, use |-clip off| option for that object.
\enddescription

\syntax
  |join <point1> <point2> ... <pointN> [OPTIONS]|
\endsyntax

\context
  scrap, survey
\endcontext

\arguments
   * |<pointX>| can be an ID of a point or line symbol,
     optionally followed by a line point mark |<id>:<mark>| 
     (e.g.~|podangl_l31@podangl:mark1|).
     |<mark>| can be also `|end|' (end of the line) or line point index
     (where 0 is the first point). 
     
     A special case is when |<point1>| and |<point2>| are scrap 
     IDs---than the closest scrap ends are joined together.
\endarguments

\options
  * |smooth <on/off>| indicates whether two lines are to be connected 
    smoothly.
  * |count <N>| (when used with scraps) = Therion will try to find more 
    connections of given two scraps  
\endoptions


\subsubchapter `grade'.

\description
   This command is used to store predefined precisions of centreline data.
   See |sd| option description for |centreline| command. 
\enddescription

\syntax:
  |grade <id>
        ...
        [<quantity list> <value> <units>]
        ...
        endgrade|
\endsyntax

\context
  all
\endcontext


\subsubchapter `revise'.

\description
  This command is used to set or change properties of an already 
  existing object.
\enddescription

\syntax
  The syntax of this command for 
  object created with ``single line'' command is
  
  |revise id [-option1 value1 -option2 value2 ...]|
  
  For objects created with ``multi line'' commands is syntax following

|revise id [-option1 value1 -option2 value2 ...]
  ...
  optionX valueX
  data
  ...
endrevise|
\endsyntax

\context
  all
\endcontext

\arguments
  The id stands for object identifier (the id of an object you want to
  revise must always be specified).
\endarguments



\subchapter XTherion.

XTherion is a GUI (Graphical User Interface) for Therion. 
It helps a lot with creating input data files. Currently it works in 
four main modes: text editor, map editor, compiler and model viewer.%
\[Here we're concerned with creating data, so only the two first modes are 
described in this section. For compiler 
features see the chapter {\it Processing data}, for model viewer features 
chapter {\it What we get?}]

It's not necessary for Therion itself---you may edit input files in your 
favourite text editor and run Therion from the command line. XTherion is also 
not the only GUI which may be used with Therion. It's possible to 
write a better one, which would be more user friendly, more WYSIWYG, faster, 
more robust and easier to use. Any volunteers?

This manual does not describe such familiar things as `if you want to save a file, go to 
menu File and select Save, or press Ctrl-s'. Browse the top menu for a minute 
to get feeling of XTherion. 

For each mode of operation, there is an additional 
right or left menu. The submenus may be packed; you may unpack them by 
clicking on the menu button. For most of the menus and buttons, there is a short 
description in the status line, so it's not hard to guess the meaning of each one.
The order of submenus on the side may be customized by the user. Right-click on 
the menu button and select in the menu which of the other menus it should 
be swapped with.


\subsubchapter XTherion---text editor.

XTherion's text editor offers some interesting features which may help with 
creating text input files: support for Unicode encoding and ability to open 
multiple files. 

To make entering data easy, it supports table formatting of centreline data. 
There is a menu {\it Data table} for typing the data. It may be customized to 
user's data order by pressing a {\it Scan data format} button when the cursor 
is below the data order specification (`data' option in the `centreline' 
command).


\subsubchapter XTherion---map editor.

Map editor allows you to draw and edit map fully interactively.
But don't expect too much. XTherion is not a truly WYSIWYG editor. It 
displays only the position, not the actual shape, of drawn point or line 
symbols. Visually there is no difference between a helictite and a text 
label---both are rendered as simple dots. The type and other attributes of any 
object are specified only in the {\it Point control} and {\it Line control} menus.


\ifx\pdfoutput\undefined\else
\leavevmode\llap{\smash{\raise10pt\hbox{\pdfannot width 6cm height 0cm depth  4cm 
{/Subtype /Text 
 /Name /Help
 /Contents (Hints: 1. What does loop closure do?
            2. Why do we use MetaPost?)
}}} \qquad}\fi
{\it Exercise:} Find two substantial reasons, why the map drawn in XTherion can't be 
identical with Therion output. (If you answer this, you'll know, why XTherion 
will never be true WYSIWYG editor. Authors' laziness is not the correct 
answer.)

Let's begin by describing typical use of the map editor. First, you have 
to decide which part of the cave (which scrap) you'll draw.\[It's possible to 
draw more than one scrap in one file, in which case all inactive scraps are rendered 
yellow.]

After creating a new file in the map editor, you may load one or more 
{\bf images}---scanned survey sketches from the cave\[XTherion can't scale nor 
rotate individual images, so use the same orientation, scale and DPI for all 
images used in the same scrap.]---as a backround for 
the drawing. Click on the {\it Insert} button in {\it Background images} menu.
Unfortunatelly, as a limitation of Tcl/Tk language, only GIF, PNM and PPM 
(plus PNG and JPEG if you installed tkImg extension) images are supported. 
All opened images are placed in the upper-left corner of 
the working area. Move them by double clicking and dragging with the right 
mouse button or through a menu. For better performance on slower computers, 
it's possible to temporarily unload a currently unused image from memory 
by unchecking its {\it Visibility} check-box. It's possible to open an existing 
file without loading of background images using {\it Open XP} menu.
\[{\it Note:} Therion doesn't use background images in any way.]

The size and zoom setting of the {\bf drawing area} is adjusted in the 
corresponding menu. {\it Auto adjust} calculates optimal size of the working 
area according to the sizes and positions of loaded background images.

After these preparation steps, you're ready for drawing, or, more 
precisely, for {\bf creating a map data file}. It's important to remember, 
that you're actually creating a text file which should conform to the syntax 
described in the chapter {\it Data format}. Actually, only a subset of the 
Therion commands are used in the Map editor: multi-line |scrap ... endscrap|
commands which may contain |point|, |line| and |area| commands. (Cf.~chapter 
{\it Data format}). This corresponds with a section of hand-drawn map, which is 
built up from points, lines and filled areas.

So, the first step is defining the {\bf scrap} by a |scrap ... endscrap| 
multi-line command.  In the {\it File commands} menu click on the {\it Action} 
submenu and select {\it Insert scrap}. This changes the {\it Action button} to
{\it Insert scrap} if it had any other value. After pressing this button a 
new scrap will be inserted. You should see lines

|scrap - scrap1
endscrap
end of file|

in the preview window above the {\it Insert scrap} button. This window is a 
simplified outline of the text file, which will be saved by XTherion. Only 
the command (|scrap|, |point|, |line|, |text|---why text see below) and its 
type (for |point| and |line|) or ID (for |scrap|) are shown. 

The full contents of any command is displayed in the {\it Command preview} 
menu.

For modifying previously-created commands, there are additional 
menus---e.g.~{\it Scrap control} for the |scrap| command. Here you can 
change the ID (very important!) and other options. 
For details see chapter {\it Data format}.

Now it's possible to insert some {\bf point symbols}. As with scrap 
insertion, go to the {\it File commands} menu, click on the {\it Action} 
submenu and select {\it Insert point}; than press newly renamed {\it Insert 
point} button. A shortcut for all this is Ctrl-p. Than click on the desired 
spot in the working area and you'll see a blue dot representing a point 
symbol. Its attributes can be adjusted in the {\it Point control} menu.
You'll stay in `insert' mode---each click on the working area adds a new 
point symbol. Take care not to click twice on the same place---you would insert 
two point symbols in the same place!
To escape from `insert' to `select' mode, press {\it Esc} key 
on the keyboard or {\it Select} button in the {\it File commands} menu.

What order will the commands be in the output file? Exactly as in the 
outline in the {\it File commands} menu. Newly created point, line and text objects 
are added before the currently marked line in the outline. It's possible to 
change the order by selecting a line and pressing {\it Move down}, 
{\it Move up} or {\it Move to} buttons in the {\it File commands} menu.

{\bf Drawing lines} is similar to drawing in other 
vector editing programs, which work with B\'ezier curves. 
(Guess how to enter the line insertion mode, other than 
using the shortcut Ctrl-l.) Click where the first point should be, then drag the 
mouse with pressed left button and release it where the first control point 
should be. Than click somewhere else (this point will be the second point of 
the curve) and drag the mouse (adjusting the second control point of the 
previous arc and the first control point of the next one simultaneously.) If 
this explanation sounds too obscure, you can 
get some practise working in some of the standard vector editors with 
comprehensive documentation. The line will be finished after escaping from the 
insertion mode. Beginning and orientation of the line is marked by a small 
orange tick to the left at the first point.

For line symbols, there are two control menus: {\it Line control} and {\it Line 
point control}. First one sets attributes for the whole curve, like type or
name. The check-box {\it reverse} is important: Therion requires oriented 
curves and it is not unusual that you begin to draw from the wrong end.
The {\it Line point control} menu enables you to adjust the attributes of any selected 
point on the line, such as the curve being smooth at this point (which is on 
by default), or the presence of neighbouring control points (`|<<|' and `|>>|' 
check-boxes).

{\bf Areas} are specified by their surrounding lines. Click on {\it Insert area}
and then click on the lines surrounding the desired area. They are 
automatically inserted in the {\it Area control} and named (if not already 
named). An alternate way is to insert them as a |text| 
command which contents (entered in the {\it Text editor} menu of the Map editor) 
is usual |area ... endarea| multi-line command (see the chapter {\it Data 
format}.) 

CAUTION! The command |text| is not a Therion command! It's only a nickname for a 
block of an arbitrary text in 
XTherion. In the file saved by XTherion, there'll only be 
whatever you type into the {\it Text editor} or see in the {\it Command preview}.
It may be an area definition or whatever you want, such as a comment beginning 
with a `|#|' character.

If you draw some scraps with |none| projection, it's necessary to 
{\bf calibrate} the 
drawing area. The scale can be defined only one way in XTherion---using 
coordinates of two points. After selecting a scrap (click on its header in the 
{\it File commands} menu) two small red squares 
will appear (by default, they'll be in the lower corners of drawing area). 
You have to drag them to points with known coordinates---usually intersections 
of mm grid lines on the scanned drawing. If you can not see these points, 
you can move pointer to desired position, read pointer coordinates from 
the status bar and enter these coordinates into {\it picture scale points}
boxes in the {\it Scrap control}. You have to fill X1,Y1 and
X2,Y2 coordinate pairs. Then you have to enter real coordinates of these
points. 

In the {\bf selection mode} you can select existing line or point objects and  
set their attributes in the corresponding menus, move them, or delete them (Ctrl-d or 
{\it Action button} in {\it File commands menu} after setting {\it Action} to 
{\it Delete}).

% [adding or deleting a point on the curve]

There is a {\it Search and select} menu, which makes it easy to
switch between objects and visualize things, you can't see at the first 
look at the picture. For example, if you enter expression `station' and 
press {\it Show All}, all stations on the picture will become red. 

XTherion doesn't do any syntax checking; it only writes drawn objects with their 
attributes to a text file. Any errors are detected only when you process these 
files with Therion.

TIP: Entering symbols of the same type at once saves you a lot of time 
because you need not change symbol type and fill options for each new symbol.
{\it Options} box preserves the old value and it's enough to change a few 
characters (e.g.~if you're entering stations, |-name 34@pajan| option inherited 
from previous station may be easily changed to |-name 35@pajan| by retyping one 
character). 
It is a good idea to start with drawing all survey stations (don't forget to 
give them names according to real names in the centreline command), than all 
passage walls followed by all other point symbols, lines and areas. Finally 
draw cross-sections.

\subsubchapter Keyboard and mouse shortcuts in the Map editor.
{\it General}
\list
 * Ctrl+Z = undo
 * Ctrl+Y = redo
 * F9 = compile current project
 * to select object in the listbox using keyboard:
    switch using `Tab' into desired listbox;
    move with underlined cursor to desired object;
    press `Space'
\endlist

{\it Drawing area and background images}
\list
 * RightClick = scroll drawing area
 * Double RightClick on the image = move the image
\endlist

{\it Inserting line}
\list
 * Crtl+L = insert new line and enter an `insert line point' mode
 * LeftClick = insert line point (without control points)
 * Ctrl+LeftClick = insert line point very close to existing point 
    (normally it's inserted right above closest existing point)
 * LeftClick + drag = insert line point (with control points)
 * hold Ctrl while dragging = fix the distance of previous control point
 * LeftClick + drag on the control point = move its position
 * RightClick on one of the previous points = selects the previous point while 
    in insert mode (useful if you want to change also the direction of
    previous control point)
 * Esc or LeftClick on the last point = end the line insertion
 * LeftClick on the first line point = close the line and end line insertion
\endlist

{\it Editing line}
\list
 * LeftClick + drag = move line point
 * Ctrl+LeftClick + drag = move line point close to the existing
    point (normally it is moved right above closest existing point)
 * LeftClick on control point + drag = move control point
\endlist

{\it Adding line point}
\list
  * select the point before which you want to insert points;
    insert required points;
    press Esc or left-click on the point you selected at the begining
\endlist
  
{\it Deleting line point}
\list
  * select the point you want to delete;
    press {\it Edit line} $\to$ {\it Delete point} in the {\it Line control} 
    panel
\endlist

{\it Splitting line}
\list
 * select the point at which you want to split the line;
    press {\it Edit line} $\to$ {\it Split line} in the {\it Line control} 
    panel
\endlist


{\it Inserting point}
\list
 * Ctrl+P = switch to `insert point' mode
 * LeftClick = insert point at given position
 * Ctrl+LeftClick = insert point very close to existing point (normally it
    will be inserted right above the closest point)
 * Esc = escape from the `inset point' mode
\endlist

{\it Editing point}
\list
 * LeftClick + drag = move point
 * Ctrl+LeftClick + drag = move point close to the existing
    point (normally it is moved right above closest existing point)
 * LeftClick + drag on point arrows = change point orientation or
    sizes (according to given switches in Point cotrol panel)
\endlist

{\it Inserting area}
\list
 * press {\it File commands} $\to$ {\it Insert area} to switch to the 
   `insert area border' mode
 * RightClick on the lines, that suround desired area
 * Esc to finish area border lines insertion
\endlist

{\it Editing area}
\list
 * select area you want to edit
 * pres `Insert' in the {\it Area control} to insert other border lines
    at current cursor position
 * pres `Insert ID' to insert border with given ID at current cursor position
 * pres `Delete' to remove selected area border line
\endlist


{\it Selecting an existing object}
\list
 * LeftClick = select object on the top
 * RightClick = select object right below the top object (useful when several
    points lie above each other)
\endlist



\subchapter Thinking in Therion.

Although everything about Therion input files has been explained, this chapter 
offers some aditional tips and hints.

\subsubchapter How to enter centreline?.

The basic building block is the |centreline| command.
If the cave is larger than a few meters it's a good idea to split data in more 
files and separate centreline data from map data. 

We usually use one |*.th| file containing centreline per survey trip. 
It's handy to 
start with an empty template file as shown bellow, where dots will be replaced 
with appropriate texts.

|encoding ISO8859-1
survey ... -title "..."
  centreline
    team "..."
    team "..."
    date ...
    units clino compass grad
    data normal from to compass clino length
      ... ... ... ... ...
  endcentreline
endsurvey|

To create a unique namespace the |centreline| command is enclosed in 
|survey| ... |endsurvey| command.
It's useful when the survey has the same name as the file which contains it. 
\[E.g.~|survey entrance| in the file |entrance.th|.] The points will than be
referenced using |@| character---see the |survey| command description.

For really large caves it's possible to build a hierarchical structure of 
directories. In such a case we create one special file called |INDEX.th| which 
includes all other |*.th| files from given directory and contains |equate| 
commands to define connections between surveys.

\subsubchapter How to draw maps?.

The most imortant thing is to devise division of the cave into scraps. Scrap is
the basic building block of the map.
It's almost always a {\it bad\/} idea to try to fit each scrap to corresponding
|*.th| file with centreline from one survey trip. The reason is that 
connections between scraps should be as simple as possible. 
Scraps in general are independent on centreline hierarchy so try to forget
the survey hierarchy when drawing maps and choose best scrap joins. 

We usually insert maps in the last-but-one level in survey hierarchy.\[Remember 
that surveys create namespaces, so you may reference only objects in the given 
survey and all subsurveys.] Each 
scrap may than contain arbitrary part of any survey in the last level of 
hierarchy. For example, there is a survey |main| which contains surveys |a|, 
|b|, |c| and |d|. Surveys |a| -- |d| contain centreline data from four survey 
trips and each of them is in a separate file. There is a map |main_map| which 
contains scraps |s1| and |s2|. If the |main_map| is located in the |main| 
survey, scrap |s1| may cover part of the centreline from survey |a|, complete 
survey |b| and part of |c|; |s2| will cover part of the |a| and |c| surveys
and a complete |d| survey. The survey stations names will be referenced using 
|@| symbol (e.g.~|1@a|) in the scraps.\[If you include maps in the top-level 
survey, you may reference any survey station in any scrap, which is very 
flexible. On the other side you have than use longer names in stations 
references, like |3@dno.katakomby.jmn.dumbier|]

Scraps are usually stored in |*.th2| files. Each file may contain more scraps. 
To keep data well organized, we have some naming conventions: in the file 
|foo.th2| all scraps are named |foo_si|, where |i| is |1|, |2| an so on. 
Cross-sections are named |foo_ci|, lines |foo_li| etc. This helps a lot with 
large cave systems: if some scrap is referenced, you immediately know in which 
file it had been defined.

Similar to |*.th| files, there may be one file |INDEX.th2| per directory which 
includes all |*.th2| files, defines scrap joins and maps.

When drawing scraps you should check if the outline is properly defined: all 
lines creating the outer border should have |-outline out| option; all lines 
surrouding inner pillars |-outline in| option. Scrap outlines can't intersect 
themselves---otherwise the inner side of the scrap can't be determined. There 
are two simple tests that scrap outline is correct:
\list
* there is no \MP\ warning ``|scrap outline intersects itself|''
* when you set passage fill to any color (|color map-fg <number>| option in 
|layout|), you may see what Therion considers to be inside of the scrap.
\endlist

\subsubchapter How to create models?.

The model is created from scrap outlines. The height and depth of the passage 
are computed from |passage-height| point map symbols. In the future, there will 
be |point dimensions| map symbol which will allow more precise floor and 
ceiling specification.


\endinput
