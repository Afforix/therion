%% 
%% therion.tex
%%
%% Copyright (C) 2001-2002 Martin Budaj
%%
%% -------------------------------------------------------------------- 
%% This program is free software; you can redistribute it and/or modify
%% it under the terms of the GNU General Public License as published by
%% the Free Software Foundation; either version 2 of the License, or
%% any later version.
%%
%% This program is distributed in the hope that it will be useful,
%% but WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%% GNU General Public License for more details.
%% 
%% You should have received a copy of the GNU General Public License
%% along with this program; if not, write to the Free Software
%% Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
%% -------------------------------------------------------------------- 

% Summary of macros to be used in therion layout files:
%
% \author{}, \title{}, \subject{}, \keywords{} 
%    -- sets the corresponding attributes of PDF file
%
% \opacity{}
%    -- in transparency mode sets the opacity value
%
% \dopage{}, \showpointer, \showpointerlist, \processpointeritem
%    -- enables custom layouts of atlas pages (see The TherionBook for details)
%
% \pagesetup{paper-width}{paper-height}
%           {page-width}{page-height}
%           {left-margin}{top-margin}
%    -- used only in atlas mode
%
% \placemaps
%    -- draws map(s)
%
% \placelegend
%    -- not supported yet
%
% \TITLE{}
%    -- creates an empty page with a large title

\def\scale{200} % !!! to be defined by therion

\ifx\pdfoutput\undefined
     \newlinechar`\^^J
     \immediate\write16{^^J^^JProcess me with pdfTeX, please!^^J^^J}
     \expandafter\end
\fi

\def\requiredformat{plain}
\ifx\requiredformat\fmtname\else
     \newlinechar`\^^J
     \immediate\write16{^^J^^JTherion works only with plain TeX format!^^J}
     \immediate\write16{Your format is: \fmtname^^J^^J}
     \expandafter\end
\fi

\parindent=0pt
\raggedbottom
\nopagenumbers
\tracingstats=1

%\pdfinfo{/Creator <feff%
%  03b803b703c103af03bf03bd0020%
%  002800740068006500720069006f006e0029002c0020%
%  004d0065007400610050006f00730074002c0020%
%  005400650058>}%
\pdfinfo{/Creator (Therion, MetaPost, TeX)}%
\pdfcatalog{ /ViewerPreferences << /DisplayDocTitle true >> }

\def\wlog#1{}

\newbox\xxx
\newbox\mapbox
\newbox\navbox
%\newbox\updownbox
\newcount\pointerE
\newcount\pointerW
\newcount\pointerN
\newcount\pointerS
\newtoks\pointerU
\newtoks\pointerD
\newcount\pagenum
\newtoks\pagename
\newtoks\pagelabel
\newtoks\opacity \opacity{0.7}
\newif\ifpagenumbering \pagenumberingfalse

\let\ne\noexpand
\def\notdef{notdef}

% hyperlinks

%\def\link#1#2#3#4{%
%  \rlap{\kern#1bp\raise#2bp\hbox{%
%  \vbox to0bp{\vss\hbox to 0bp{\hss
%  \pdfstartlink attr {/Border [0 0 0]} goto name {#4}%
%  \pdfrefxform#3\pdfendlink\hss}%
%  \vss}}}}

\def\flatlink#1#2#3#4#5{%
  \setbox\xxx=\hbox{}\wd\xxx=#3bp\ht\xxx=#4bp%
  \rlap{\kern#1bp\raise#2bp\hbox{%
  \vbox to0bp{\vss\hbox to 0bp{%
  \pdfstartlink attr {/Border [0 0 0]} goto name {#5}%
  \box\xxx\pdfendlink\hss}}}}}%

\def\textlink#1#2{%
  \pdfstartlink attr {/Border [0 0 0]} goto name {#2}#1\pdfendlink}%


\def\includechars#1:#2\endinclude{\pdfincludechars#1{#2}}

    
% there should be more general font selection in the future

\font\big=csss10 at 20 pt
\font\middle=csss10 at 16 pt
\font\norm=csss10

\norm

\def\legendbox#1#2{\hbox{\raise12pt\vtop{\pdfrefxform#1}\quad#2}\medskip}

\let\PL\pdfliteral

\def\PB#1#2#3{\rlap{\kern#1bp\raise#2bp\hbox{\pdfrefxform#3}}} %placebox

\def\TITLE#1{\eject\hbox{}\vskip5cm\centerline{\big#1}\vfil\eject}

% processing of the E-W-N-S references

\def\showpointer#1{\ifnum\the#1=0\else\the#1\fi}

% processing of the up and down references

\def\showpointerlist#1{\edef\test{\the#1}\ifx\test\notdef\else
                   \expandafter\process\the#1\endarg\fi}

\def\process#1||#2\endarg{
  \expandafter\processpointeritem#1\endarg%
  \if@#2@\def\next##1\endarg{}
  \else\let\next=\process\fi
  \next#2\endarg}

\def\processpointeritem#1|#2|#3\endarg{\hbox{\textlink{\arr\ #2 (#1)}{#3}}}

\def\arr{}        % to be redefined in the \dopage macro

\newdimen\scw

\def\scalebar#1#2{%  % the number must be less than 500
    \scw=#1cm
    \divide\scw by \scale
    \multiply\scw by \ifx#2m100\else31\fi 
    \advance\scw by 0.4pt
    \vbox{\hsize=\scw\baselineskip=0pt
      \centerline{#1\thinspace#2}
      \line{\vrule height3pt\hfil\vrule}
      \hrule
    }%
  }


% 

\def\author#1{\pdfinfo{ /Author <feff#1>}}
\def\title#1{\pdfinfo{ /Title <feff#1>}}
\def\subject#1{\pdfinfo{ /Subject <feff#1>}}
\def\keywords#1{\pdfinfo{ /Keywords <feff#1>}}

\def\pagesetup#1#2#3#4#5#6{
  \pdfpagewidth#1
  \pdfpageheight#2
  \hsize#3
  \vsize#4
  \pdfhorigin#5
  \pdfvorigin#6
  \hoffset0pt
  \voffset0pt\relax
}

% actual placing of the page elements

\def\dopage{%
  \vbox{\line{\hfil\box\mapbox\hfil}
    \bigskip
    \line{%
     \vbox to \ht\navbox{
      \hbox{\big\the\pagelabel
        \ifpagenumbering\space(\the\pagenum)\fi
        \space\middle\the\pagename}
      \ifpagenumbering
        \medskip
        \hbox{\qquad\qquad
          \vtop{%
  	    \hbox to 0pt{\hss\showpointer\pointerN\hss}
            \hbox to 0pt{\llap{\showpointer\pointerW\hskip0.7em}%
	           \raise1pt\hbox to 0pt{\hss$\updownarrow$\hss}%
	           \raise1pt\hbox to 0pt{\hss$\leftrightarrow$\hss}%
		   \rlap{\hskip0.7em\showpointer\pointerE}}
  	    \hbox to 0pt{\hss\showpointer\pointerS\hss}
	  }\qquad\qquad
          \vtop{
	    \def\arr{$\uparrow$}
	    \showpointerlist\pointerU
	    \def\arr{$\downarrow$}
	    \showpointerlist\pointerD
	  }
        }
      \fi
      \vss
      \scalebar{10}m
      }\hss
      \box\navbox
    }
  }
}

\def\maplegend{}

\def\insertmaps{%
  \input th_resources
  \input th_fontdef
  \input th_formdef
  \input th_pagedef
  \input th_pages
}
    
\def\insertlegend{%
  \input legend
}

\def\placemaps{
  \message{ [Warning: \string\placemaps\space is deprecated; 
            use \string\insertmaps] }
  \insertmaps
}

\errorstopmode

